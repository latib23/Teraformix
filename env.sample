import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { ServeStaticModule } from '@nestjs/serve-static';
import { join } from 'path';
import { AuthModule } from './auth/auth.module';
import { UsersModule } from './users/users.module';
import { CompaniesModule } from './companies/companies.module';
import { ProductsModule } from './products/products.module';
import { QuotesModule } from './quotes/quotes.module';
import { OrdersModule } from './orders/orders.module';
import { SearchModule } from './search/search.module';
import { CmsModule } from './cms/cms.module';
import { ShippingModule } from './shipping/shipping.module';
import { NotificationsModule } from './notifications/notifications.module';
import { DashboardModule } from './dashboard/dashboard.module';

// Entities
import { User } from './users/entities/user.entity';
import { Company } from './companies/entities/company.entity';
import { Product } from './products/entities/product.entity';
import { Quote } from './quotes/entities/quote.entity';
import { Order } from './orders/entities/order.entity';
import { ContentBlock } from './cms/entities/content-block.entity';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    // Serve Static React Files
    ServeStaticModule.forRoot({
      rootPath: join(__dirname, '..', 'dist-client'),
      exclude: ['/api/(.*)'], // Ensure API routes aren't intercepted
    }),
    TypeOrmModule.forRootAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (configService: ConfigService) => {
        const isProduction = configService.get<string>('NODE_ENV') === 'production';
        
        return {
          type: 'postgres',
          host: configService.get<string>('DB_HOST', 'localhost'),
          port: configService.get<number>('DB_PORT', 5432),
          username: configService.get<string>('DB_USERNAME', 'admin'),
          password: configService.get<string>('DB_PASSWORD', 'password123'),
          database: configService.get<string>('DB_DATABASE', 'server_tech_db'),
          ssl: isProduction ? { rejectUnauthorized: false } : false,
          entities: [User, Company, Product, Quote, Order, ContentBlock],
          autoLoadEntities: true,
          // Auto-sync schema in development, disable in production to prevent data loss
          synchronize: !isProduction, 
          logging: false,
          retryAttempts: 3,
          retryDelay: 3000,
        };
      },
    }),
    AuthModule,
    UsersModule,
    CompaniesModule,
    ProductsModule,
    QuotesModule,
    OrdersModule,
    SearchModule,
    CmsModule,
    ShippingModule,
    NotificationsModule,
    DashboardModule,
  ],
})

# Microsoft Clarity
CLARITY_PROJECT_ID=so49yg178g

# Airtable Integration
AIRTABLE_API_KEY=
AIRTABLE_BASE_ID=
AIRTABLE_CUSTOMERS_TABLE=Customers
AIRTABLE_ORDERS_TABLE=Orders
